<script>
document.addEventListener("DOMContentLoaded", () => {
  const subjects=["ä¸­æ–‡","è‹±æ–‡","æ•¸å­¸","åŒ–å­¸","M2","ç‰©ç†","ç¶“æ¿Ÿ","æœƒè¨ˆ","ICT"];
  const gradeValue={ "5**":7,"5*":6,"5":5,"4":4,"3":3,"2":2,"1":1 };
  const todayStr=new Date().toLocaleDateString("zh-HK");

  const tbody=document.querySelector("#gradeTable tbody");
  subjects.forEach(s=>{
    const row=document.createElement("tr");
    row.innerHTML=`<td>${s}</td>
    <td><select id="g_${s}">
      <option value="">--é¸æ“‡ç­‰ç´š--</option>
      ${Object.keys(gradeValue).map(g=>`<option>${g}</option>`).join("")}
    </select></td>`;
    tbody.appendChild(row);
  });
  document.getElementById("todayDate").textContent=todayStr;

  let chart;
  function calcWeights(){
    let scores={};
    subjects.forEach(s=>{
      const g=document.getElementById("g_"+s).value;
      const val=gradeValue[g]||0;
      scores[s]=val? (8-val):0;
    });
    return scores;
  }
  function suggestSubjects(weights){
    const entries=Object.entries(weights).filter(([_,v])=>v>0);
    if(entries.length===0)return{main:"æœªå®š",sub:"æœªå®š"};
    entries.sort((a,b)=>b[1]-a[1]);
    const main=entries[0][0];
    const sub=entries[1]?entries[1][0]:entries[0][0];
    return{main,sub};
  }
  function drawChart(weights){
    const data=Object.values(weights);
    const labels=Object.keys(weights);
    const ctx=document.getElementById("pieChart").getContext("2d");
    if(chart)chart.destroy();
    chart=new Chart(ctx,{
      type:"pie",
      data:{
        labels:labels,
        datasets:[{
          data:data,
          backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40","#8BC34A","#E91E63","#9C27B0","#00BCD4"]
        }]
      },
      options:{plugins:{legend:{position:"right"},title:{display:true,text:"å»ºè­°æº«ç¿’æ™‚é–“åˆ†é…"}}}
    });
  }

  document.getElementById("calcBtn").addEventListener("click",()=>{
    const weights=calcWeights();
    drawChart(weights);
    const {main,sub}=suggestSubjects(weights);
    document.getElementById("autoResult").innerHTML=`ğŸ’¡ å»ºè­°ä¸»ç§‘ï¼š<b>${main}</b> ï½œ å‰¯ç§‘ï¼š<b>${sub}</b>`;
    localStorage.setItem("todaySuggestion",JSON.stringify({date:todayStr,main,sub,weights}));
    const msgDiv=document.getElementById("msg");
    msgDiv.className="success";
    msgDiv.innerHTML=`âœ…â€¯å·²è‡ªå‹•ç”Ÿæˆä¸¦å„²å­˜ã€‚<br>3â€¯ç§’å¾Œå°‡è¿”å›æ¯æ—¥æ‰“å¡é â€¦`;
    setTimeout(()=>window.location.href="index.html",3000);
  });

  // âœ… ä¿®æ­£ï¼šæ­£ç¢ºæ‹¬è™Ÿçµæ§‹
  document.getElementById("backBtn")
          .addEventListener("click", () => window.location.href = "index.html");
});
</script>
