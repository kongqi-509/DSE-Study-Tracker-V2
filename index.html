<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DSE å­¸ç¿’æ‰“å¡</title>
<style>
:root{--primary:#0052cc;--accent:#4caf50;--bg:#f7faff;--text:#222;--panel:#fff;}
@media (prefers-color-scheme:dark){
  :root{--primary:#4a90e2;--accent:#00cc66;--bg:#1e1e1e;--text:#f0f0f0;--panel:#2a2a2a;}
}
body{font-family:"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text);margin:0;}
header{background:var(--primary);color:white;text-align:center;padding:1rem;}
#clock{font-size:1.3rem;font-weight:bold;}
main{background:var(--panel);max-width:750px;margin:1rem auto;border-radius:12px;padding:1rem;box-shadow:0 0 8px rgba(0,0,0,0.15);}
h2{border-left:6px solid var(--primary);padding-left:6px;font-size:1rem;}
#suggestion{background:#e8f0ff;padding:0.6rem;border-radius:8px;margin-bottom:1rem;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:0.5rem;text-align:center;}
th{background:var(--primary);color:white;}
td.school{background:#f0f0f0;color:#777;}
.subject-input{width:100%;border:none;border-bottom:1px solid #ccc;background:transparent;text-align:center;color:var(--text);}
input[type=checkbox]{transform:scale(1.2);}
.buttons{text-align:center;margin:1rem 0;}
button{border:none;border-radius:6px;padding:0.6rem 1rem;margin:0.3rem;font-size:0.9rem;cursor:pointer;color:white;}
button.save{background:var(--primary);}
button.clear{background:#666;}
button.export{background:var(--accent);}
button.timer{background:#f39c12;}
button.plan{background:#2e8b57;}
button.plan:hover{background:#3da96a;}
button.history{background:#7979ff;}
.progress-bar{width:100%;height:16px;background:#ddd;border-radius:8px;border:1px solid #bbb;overflow:hidden;}
.progress-fill{height:100%;width:0;background:var(--accent);min-width:4px;transition:width 0.4s ease;}
.progress-label{text-align:right;font-size:0.85rem;margin-top:0.3rem;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:white;padding:0.6rem 1rem;border-radius:6px;opacity:0;transition:opacity .5s;z-index:999;}
.toast.show{opacity:1;}
footer{text-align:center;font-size:0.8rem;color:#888;margin:1rem 0;}
#timerBox{display:none;text-align:center;margin-top:0.5rem;}
#timerDisplay{font-size:1.2rem;font-weight:bold;color:var(--primary);}
#historyBox{background:#f3f6ff;border-radius:8px;padding:0.6rem;margin-top:0.6rem;max-height:150px;overflow-y:auto;font-size:0.9rem;}
</style>
</head>
<body>
<header>
  <h1>ğŸ“š DSE å­¸ç¿’æ‰“å¡</h1>
  <div id="date"></div>
  <div id="clock">--:--:--</div>
</header>

<main>
  <div style="text-align:center;margin:0.5rem 0 1rem 0;">
    <button class="plan" onclick="window.location.href='plan.html'">ğŸ“Š èª¿æ•´å­¸ç¿’è¨ˆåŠƒ</button>
  </div>

  <h2>ğŸ§  ä»Šæ—¥å»ºè­°ç§‘ç›®</h2>
  <div id="suggestion">è¼‰å…¥ä¸­...</div>

  <h2>ğŸ—“ï¸ ä»Šæ—¥æ‰“å¡</h2>
  <table><thead><tr><th>æ™‚é–“</th><th>å…§å®¹</th><th>å®Œæˆ</th></tr></thead><tbody id="scheduleBody"></tbody></table>

  <div class="buttons">
    <button class="save" id="save">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
    <button class="clear" id="clear">ğŸ§¹ æ¸…é™¤</button>
    <button class="export" id="export">ğŸ“¤ åŒ¯å‡ºæœ¬é€±å ±å‘Š</button>
    <button class="timer" id="startTimer">â± é–‹å•Ÿè¨ˆæ™‚å™¨</button>
    <button class="history" onclick="toggleHistory()">ğŸ“… æŸ¥çœ‹æ­·å²ç´€éŒ„</button>
  </div>

  <div id="timerBox">
    <div>å€’æ•¸æ™‚é–“ï¼š<span id="timerDisplay">00:00</span></div>
    <button class="clear" id="stopTimer">åœæ­¢</button>
  </div>

  <h2>ğŸ“Š æœ¬é€±å®Œæˆç‡</h2>
  <div class="progress-bar"><div class="progress-fill" id="pfill"></div></div>
  <div class="progress-label" id="plabel">0%</div>

  <div id="historyBox" style="display:none;">å°šç„¡ç´€éŒ„</div>
</main>

<footer>Â© 2025-2026 DSE Study Tracker V2</footer>
<div class="toast" id="toast">âœ… å·²å„²å­˜ï¼</div>

<script>
// === æ™‚é˜èˆ‡æ—¥æœŸ ===
function updateClock(){
  const now=new Date();
  document.getElementById("clock").innerText=now.toLocaleTimeString("zh-HK",{hour12:false});
}
setInterval(updateClock,1000);updateClock();

const today=new Date();
const w="æ—¥ä¸€äºŒä¸‰å››äº”å…­"[today.getDay()];
document.getElementById("date").innerText=`${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ï¼ˆæ˜ŸæœŸ${w}ï¼‰`;
const keyPrefix=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

// === æ¯å¤©åˆå¤œè‡ªå‹•æ¸…é™¤ä»Šæ—¥è³‡æ–™ï¼ˆåƒ…ç•¶è·¨æ—¥æ™‚è§¸ç™¼ï¼‰ ===
function scheduleMidnightReset(){
  const now=new Date();
  const tomorrow=new Date(now);
  tomorrow.setDate(now.getDate()+1);
  tomorrow.setHours(0,0,0,5);
  const ms=tomorrow-now;
  setTimeout(()=>{clearToday();location.reload();},ms);
}
function clearToday(){
  for(let i=0;i<20;i++){
    localStorage.removeItem(keyPrefix+"_s"+i);
    localStorage.removeItem(keyPrefix+"_c"+i);
  }
}
scheduleMidnightReset();

// === è‡ªå‹•æ¸…é™¤30å¤©ä»¥ä¸ŠèˆŠç´€éŒ„ ===
function clearOldRecords(){
  const all=JSON.parse(localStorage.getItem("studyHistory")||"{}");
  const now=new Date();
  for(const k in all){
    const d=new Date(k);
    if((now-d)/(86400000)>30){
      for(let j=0;j<20;j++){
        localStorage.removeItem(k+"_s"+j);
        localStorage.removeItem(k+"_c"+j);
      }
      delete all[k];
    }
  }
  localStorage.setItem("studyHistory",JSON.stringify(all));
}
clearOldRecords();

// === ä»Šæ—¥å»ºè­°ç§‘ç›®åŒæ­¥ ===
function loadSuggestion(){
  const sug=JSON.parse(localStorage.getItem("todaySuggestion")||"{}");
  const sugDiv=document.getElementById("suggestion");
  const todayStr=new Date().toLocaleDateString("zh-HK");
  if(sug.date===todayStr&&sug.main){
    sugDiv.innerHTML=`ğŸ’¡ <b>ä¸»ç§‘ï¼š</b>${sug.main}<br>ğŸ§© <b>å‰¯ç§‘ï¼š</b>${sug.sub}`;
  }else{sugDiv.textContent="ğŸ“… å°šæœªè¨­å®šä»Šæ—¥å»ºè­°ï¼Œè«‹è‡³ã€Œèª¿æ•´å­¸ç¿’è¨ˆåŠƒã€ç”Ÿæˆ";}
}
loadSuggestion();

// === æ™‚æ®µè¡¨ ===
const tbody=document.getElementById("scheduleBody");
const weekday=today.getDay();
const schedule=(weekday>=1&&weekday<=5)?
[{time:"08:00â€“16:30",school:true,label:"å­¸æ ¡ä¸Šèª²æ™‚é–“"},
{time:"17:00â€“18:00"},{time:"18:00â€“19:30"},{time:"19:30â€“21:00"},{time:"21:00â€“22:30"}]:
[{time:"09:00â€“10:30"},{time:"10:30â€“12:00"},{time:"13:00â€“14:30"},{time:"14:30â€“16:00"},{time:"16:00â€“17:30"},{time:"19:00â€“20:30"},{time:"20:30â€“22:00"}];
let ids=[],idx=0;
schedule.forEach(s=>{
  const tr=document.createElement("tr");
  if(s.school){tr.innerHTML=`<td>${s.time}</td><td class="school">${s.label}</td><td>ğŸ«</td>`;}
  else{
    const sid="s"+idx,cid="c"+idx;
    ids.push(sid,cid);
    tr.innerHTML=`<td>${s.time}</td><td><input id="${sid}" class="subject-input" placeholder="å­¸ç¿’å…§å®¹"></td><td><input type="checkbox" id="${cid}"></td>`;
    idx++;
  }
  tbody.appendChild(tr);
});

// === Toast èˆ‡è³‡æ–™è™•ç† ===
function toast(msg){const t=document.getElementById("toast");t.innerText=msg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000);}
function saveData(){
  const record=[];ids.forEach(id=>{const el=document.getElementById(id);
    if(el.type==="checkbox"){localStorage.setItem(keyPrefix+"_"+id,el.checked);if(el.checked)record.push(id);}
    else localStorage.setItem(keyPrefix+"_"+id,el.value);
  });
  const sug=JSON.parse(localStorage.getItem("todaySuggestion")||"{}");
  const all=JSON.parse(localStorage.getItem("studyHistory")||"{}");
  all[keyPrefix]={date:keyPrefix,main:sug.main||"æœªå®š",sub:sug.sub||"æœªå®š",checked:record.length};
  localStorage.setItem("studyHistory",JSON.stringify(all));
  toast("âœ… å·²å„²å­˜");updateProgress();loadHistory();
}
function loadData(){
  ids.forEach(id=>{
    const el=document.getElementById(id);
    const v=localStorage.getItem(keyPrefix+"_"+id);
    if(v!==null){if(el.type==="checkbox")el.checked=(v==="true");else el.value=v;}
  });
}
function clearData(){if(confirm("ç¢ºå®šè¦æ¸…é™¤ä»Šæ—¥ç´€éŒ„ï¼Ÿ")){clearToday();location.reload();}}
document.getElementById("save").onclick=saveData;
document.getElementById("clear").onclick=clearData;
loadData();

// === é€±å®Œæˆç‡ ===
function updateProgress(){
  const now=new Date();let total=0,done=0;
  for(let i=0;i<7;i++){
    const d=new Date(now);d.setDate(now.getDate()-i);
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    for(let j=0;j<15;j++){const st=localStorage.getItem(k+"_c"+j);if(st!==null){total++;if(st==="true")done++;}}
  }
  const per=total?Math.round(done/total*100):0;
  document.getElementById("pfill").style.width=per+"%";
  document.getElementById("pfill").style.background=per<50?"#ff4d4d":per<80?"#ffc107":"var(--accent)";
  document.getElementById("plabel").innerText=per+"%";
}
document.querySelectorAll("input[type=checkbox]").forEach(c=>c.onchange=updateProgress);
window.addEventListener("DOMContentLoaded",updateProgress);

// === è¨ˆæ™‚å™¨ ===
let timer=null,timeLeft=0;
const tBox=document.getElementById("timerBox"),tDisp=document.getElementById("timerDisplay");
function fmt(s){const m=String(Math.floor(s/60)).padStart(2,"0"),sec=String(s%60).padStart(2,"0");return`${m}:${sec}`;}
document.getElementById("startTimer").onclick=()=>{
  let mins=parseInt(prompt("è¼¸å…¥å€’æ•¸åˆ†é˜ï¼š","25"));if(isNaN(mins)||mins<=0)return;
  timeLeft=mins*60;tBox.style.display="block";render();toast("â± è¨ˆæ™‚é–‹å§‹ "+mins+" åˆ†");
  clearInterval(timer);
  timer=setInterval(()=>{timeLeft--;render();if(timeLeft<=0){clearInterval(timer);toast("âŒ› æ™‚é–“åˆ°ï¼Œè‡ªå‹•å„²å­˜ï¼");saveData();tBox.style.display="none";}},1000);
};
document.getElementById("stopTimer").onclick=()=>{clearInterval(timer);tBox.style.display="none";toast("â¹ å·²åœæ­¢");};
function render(){tDisp.textContent=fmt(timeLeft);}

// === åŒ¯å‡ºå ±å‘Š ===
document.getElementById("export").onclick=()=>{
  let csv="æ—¥æœŸ,æ™‚é–“,å…§å®¹,å®Œæˆ\n";
  for(let i=0;i<7;i++){
    const d=new Date();d.setDate(d.getDate()-i);
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    for(let j=0;j<15;j++){
      const sub=localStorage.getItem(k+"_s"+j)||"";
      const done=localStorage.getItem(k+"_c"+j)==="true"?"âœ”":"";
      if(sub||done)csv+=`${k},æ™‚æ®µ${j+1},${sub},${done}\n`;
    }
  }
  const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="DSE-Week-Report.csv";a.click();toast("ğŸ“¤ å·²åŒ¯å‡ºå ±å‘Š");
};

// === æ­·å²ç´€éŒ„ ===
function loadHistory(){
  const b=document.getElementById("historyBox");
  const all=JSON.parse(localStorage.getItem("studyHistory")||"{}");
  const keys=Object.keys(all).sort((a,b)=>new Date(b)-new Date(a));
  if(keys.length===0){b.textContent="å°šç„¡ç´€éŒ„";return;}
  b.innerHTML=keys.map(k=>`<div>ğŸ“… ${all[k].date} ï½œ ä¸»ç§‘ï¼š${all[k].main} ï½œ å‰¯ç§‘ï¼š${all[k].sub} ï½œ âœ… å®Œæˆæ™‚æ®µï¼š${all[k].checked}</div>`).join("");
}
function toggleHistory(){const b=document.getElementById("historyBox");b.style.display=b.style.display==="none"?"block":"none";if(b.style.display==="block")loadHistory();}
loadHistory();

window.addEventListener("storage",e=>{if(e.key==="todaySuggestion")location.reload();});
</script>
</body>
</html>
