<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š æ¯æ—¥æ‰“å¡</title>
<style>
body{font-family:"Noto Sans TC",sans-serif;background:#f2f5f8;margin:0;padding:20px;color:#222;}
h1{text-align:center;color:#007bff;margin-bottom:5px;}
#datetime{text-align:center;font-weight:bold;color:#333;margin-bottom:15px;}
.card{background:#fff;margin:20px auto;padding:20px;border-radius:8px;box-shadow:0 3px 8px rgba(0,0,0,0.1);max-width:900px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:8px;text-align:center;border-bottom:1px solid #e0e0e0;}
th{background:#0d6efd;color:white;}
button{border:none;border-radius:6px;padding:8px 12px;font-size:0.95em;cursor:pointer;color:#fff;}
button:hover{opacity:0.9;}
.set-plan-btn{background:#17a2b8;margin-left:10px;font-size:0.9em;}
.add-btn{background:#28a745;margin:10px 0;}
.save-btn{background:#0d6efd;}
.clear-btn{background:#6c757d;}
.export-btn{background:#ff9800;}
.history-btn{background:#17a2b8;}
.del-btn{background:#dc3545;}
.timer-btn{background:#7952b3;}
.progress-container{background:#eee;height:18px;border-radius:10px;overflow:hidden;margin-top:12px;box-shadow:inset 0 1px 4px rgba(0,0,0,0.2);}
.progress-bar{height:100%;width:0%;transition:width .4s ease,background .6s ease;}
#percentTxt{text-align:center;font-weight:bold;margin-top:6px;}
input[type=time],input[type=text]{padding:4px 6px;border:1px solid #ccc;border-radius:4px;}
.check-cb{transform:scale(1.2);}
#timerDisplay{font-size:1.4em;font-weight:bold;color:#7952b3;margin:10px 0;text-align:center;}
</style>
</head>

<body>

<h1>ğŸ“š æ¯æ—¥æ‰“å¡</h1>
<div id="datetime">--:--</div>

<div class="card">
  <h2>
    ğŸ§  ä»Šæ—¥å»ºè­°ç§‘ç›®
    <button id="gotoPlan" class="set-plan-btn">ğŸ“â€¯è¨­å®š/ä¿®æ”¹è¨ˆåŠƒ</button>
  </h2>
  <p>
    ğŸ’¡ ä¸»ç§‘ï¼š<b id="mainSubject">å°šæœªè¼‰å…¥</b>ã€€
    ğŸŒ¿ å‰¯ç§‘ï¼š<b id="subSubject">å°šæœªè¼‰å…¥</b>ã€€
    <span id="planDate" style="color:#999;font-size:0.9em;"></span>
  </p>
  <hr>

  <h2>ğŸ•’ ä»Šæ—¥æ™‚æ®µè¨­å®š</h2>
  <button class="add-btn" id="addRowBtn">â• æ–°å¢æ™‚æ®µï¼ˆè‡³å°‘ä¸‰å€‹ï¼‰</button>
  <table id="todayTable">
    <thead>
      <tr><th>é–‹å§‹</th><th>çµæŸ</th><th>å…§å®¹</th><th>å®Œæˆ âœ…</th><th>åˆªé™¤</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="percentTxt">0%</div>

  <h3>â±ï¸ è¨ˆæ™‚å™¨</h3>
  <div id="timerDisplay">00:00:00</div>
  <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:10px;">
    <button class="timer-btn" id="startTimer">â–¶ï¸ é–‹å§‹</button>
    <button class="timer-btn" id="pauseTimer">â¸ æš«åœ</button>
    <button class="timer-btn" id="resetTimer">â¹ æ­¸é›¶</button>
  </div>

  <div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:10px;">
    <button class="save-btn" id="saveBtn">ğŸ’¾ å„²å­˜ä»Šæ—¥ç´€éŒ„</button>
    <button class="clear-btn" id="clearBtn">ğŸ—‘ æ¸…ç©ºå…¨éƒ¨</button>
    <button class="history-btn" id="historyBtn">ğŸ“œ æŸ¥è©¢æ­·å²</button>
    <button class="export-btn" id="exportBtn">ğŸ“¤ åŒ¯å‡º CSV</button>
  </div>

  <div id="historyContainer" style="margin-top:15px;display:none;">
    <h3>ğŸ“… æ­·å²ç´€éŒ„</h3>
    <select id="historySelect"></select>
    <pre id="historyOutput" style="background:#f8f9fa;padding:10px;border-radius:6px;white-space:pre-wrap;"></pre>
  </div>
</div>

<footer style="text-align:center;color:#777;font-size:0.85em;margin-top:20px;">
Â©â€¯2025â€¯DSEâ€¯Studyâ€¯Tracker
</footer>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  // ======== é¡¯ç¤ºæ™‚é–“èˆ‡æ˜ŸæœŸ ========
  function updateDateTime(){
    const now=new Date(),week=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    document.getElementById("datetime").textContent=
      now.toLocaleTimeString("zh-HK",{hour12:false})+"ã€€"+
      now.toLocaleDateString("zh-HK")+`ï¼ˆé€±${week[now.getDay()]}ï¼‰`;
  }
  setInterval(updateDateTime,1000);updateDateTime();

  // ======== æ‰“é–‹ plan.html ========
  document.getElementById("gotoPlan").addEventListener("click",()=>{
    window.location.href="plan.html";
  });

  // ======== é¡¯ç¤ºå»ºè­°ç§‘ç›® ========
  const suggest=JSON.parse(localStorage.getItem("todaySuggestion")||"{}");
  document.getElementById("mainSubject").textContent=suggest.main||"æœªå®š";
  document.getElementById("subSubject").textContent=suggest.sub||"æœªå®š";
  document.getElementById("planDate").textContent=suggest.date?`è¨­å®šæ–¼ ${suggest.date}`:"";

  // ======== ä¸»è¦è³‡æ–™èˆ‡é€²åº¦ ========
  const tbody=document.querySelector("#todayTable tbody");
  const progressBar=document.getElementById("progressBar");
  const percentTxt=document.getElementById("percentTxt");
  const todayKey=new Date().toISOString().split("T")[0];
  const allData=JSON.parse(localStorage.getItem("historyData")||"{}");

  function calcProgress(){
    const rows=[...tbody.children];
    const total=rows.length;
    const done=rows.filter(r=>r.querySelector(".check-cb").checked).length;
    const percent=total?Math.round((done/total)*100):0;
    const color=percent<50?`rgb(255,${percent*5.1},0)`:`rgb(${255-(percent-50)*5.1*2},255,0)`;
    progressBar.style.width=percent+"%";
    progressBar.style.background=`linear-gradient(90deg,orange,${color})`;
    percentTxt.textContent=percent+"%";
  }

  function addRow(data={}){
    const row=document.createElement("tr");
    row.innerHTML=`
      <td><input type="time" class="start" value="${data.start||""}"></td>
      <td><input type="time" class="end" value="${data.end||""}"></td>
      <td><input type="text" class="subj" value="${data.subj||""}" placeholder="ç§‘ç›®/å…§å®¹"></td>
      <td><input type="checkbox" class="check-cb" ${data.done?"checked":""}></td>
      <td><button class="del-btn">åˆªé™¤</button></td>`;
    row.querySelectorAll("input").forEach(i=>i.addEventListener("input",calcProgress));
    row.querySelector(".del-btn").addEventListener("click",()=>{
      if(tbody.children.length<=3){alert("â— è‡³å°‘éœ€ä¿ç•™ä¸‰å€‹æ™‚æ®µ");return;}
      row.remove();calcProgress();
    });
    tbody.appendChild(row);calcProgress();
  }

  if(allData[todayKey]) allData[todayKey].forEach(addRow);
  else for(let i=0;i<3;i++)
    addRow({subj:i===0?suggest.main||"":suggest.sub||""});

  document.getElementById("addRowBtn").addEventListener("click",()=>addRow());

  document.getElementById("saveBtn").addEventListener("click",()=>{
    if(tbody.children.length<3){alert("âš ï¸ è‡³å°‘ä¸‰å€‹æ™‚æ®µï¼");return;}
    const rows=[...tbody.children].map(r=>({
      start:r.querySelector(".start").value,
      end:r.querySelector(".end").value,
      subj:r.querySelector(".subj").value,
      done:r.querySelector(".check-cb").checked
    }));
    allData[todayKey]=rows;
    localStorage.setItem("historyData",JSON.stringify(allData));
    alert("âœ… ä»Šæ—¥ç´€éŒ„å·²å„²å­˜ï¼");
  });

  document.getElementById("clearBtn").addEventListener("click",()=>{
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºä»Šå¤©è³‡æ–™ï¼Ÿ")){
      delete allData[todayKey];
      localStorage.setItem("historyData",JSON.stringify(allData));
      tbody.innerHTML="";for(let i=0;i<3;i++) addRow({subj:i===0?suggest.main||"":suggest.sub||""});
      calcProgress();
    }
  });

  document.getElementById("exportBtn").addEventListener("click",()=>{
    let csv="æ—¥æœŸ,é–‹å§‹,çµæŸ,å…§å®¹,å®Œæˆ\n";
    for(const [date,rows] of Object.entries(allData)){
      rows.forEach(r=>{csv+=`${date},${r.start},${r.end},${r.subj},${r.done?"æ˜¯":"å¦"}\n`;});
    }
    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="æ‰“å¡ç´€éŒ„.csv";
    a.click();
  });

  const histCont=document.getElementById("historyContainer");
  const histSel=document.getElementById("historySelect");
  const histOut=document.getElementById("historyOutput");
  document.getElementById("historyBtn").addEventListener("click",()=>{
    histCont.style.display=histCont.style.display==="none"?"block":"none";
    histSel.innerHTML="";
    Object.keys(allData).sort().reverse().forEach(d=>{
      const o=document.createElement("option");o.value=d;o.textContent=d;histSel.appendChild(o);
    });
  });
  histSel.addEventListener("change",()=>{
    const d=histSel.value;const rec=allData[d]||[];
    const total=rec.length||1;const done=rec.filter(r=>r.done).length;
    const percent=Math.round((done/total)*100);
    histOut.textContent=`å®Œæˆç‡ï¼š${percent}%\n`+
      rec.map((r,i)=>`${i+1}. ${r.start}~${r.end} ${r.subj} ${r.done?"âœ…":"âŒ"}`).join("\n");
  });

  // ======== è¨ˆæ™‚å™¨ ========
  const timerDisplay=document.getElementById("timerDisplay");
  let sec=0,timer=null;
  const fmt=s=>`${String(Math.floor(s/3600)).padStart(2,"0")}:${String(Math.floor((s%3600)/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;
  const updateTimer=()=>timerDisplay.textContent=fmt(sec);
  document.getElementById("startTimer").addEventListener("click",()=>{if(!timer)timer=setInterval(()=>{sec++;updateTimer();},1000);});
  document.getElementById("pauseTimer").addEventListener("click",()=>{clearInterval(timer);timer=null;});
  document.getElementById("resetTimer").addEventListener("click",()=>{clearInterval(timer);timer=null;sec=0;updateTimer();});
});
</script>

</body>
</html>
